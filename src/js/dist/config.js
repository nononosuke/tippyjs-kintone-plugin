jQuery.noConflict(),function(e,t){"use strict";var n=["TIPS名","TIPSの要素","TIPS表示位置","TIPSの内容","リンク先(a要素の場合)"],i="tipsConfigDetail",r="tipsConfigList",l=["input","input","select","select","textarea","input","button"],a=["","input","select","select","textarea","input","button"],o=["tipId","tipName","tipElement","tipPosition","tipDetail","tipLink","tipsDelButton"],c=["文字色","文字サイズ","背景色"],d="cssConfig",p=e(".tips-config-list-add-button"),u=e(".csvExport"),s=kintone.plugin.app.getConfig(t),f=e(".js-submit-settings"),v=e(".js-cancel-button"),h=e('table[name="tips-config-detail"]'),g=e('table[name="tips-config-list"]'),m=e('table[name="css-config"]');function I(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function w(t){for(var n=e("<select>"),i=0;i<t.length;i++){var r=e("<option>");r.attr("value",t[i]),r.text(t[i]),n.append(r)}return n}function C(e,t,n){if(void 0!==e)for(var i=JSON.parse(e),r=t[0].children[0].children,l=1;l<r.length;l++){var a=r[l].children,o=a[0].textContent;if(i.hasOwnProperty(o))for(var c=1;c<a.length;c++)a[c].firstChild.value=i[o][n[c-1]]}}function E(e,t){for(var n=JSON.parse(e),i=1,r=0,l=Object.keys(n);r<l.length;r++){var c=l[r];S(t,a,o,c);var d=t[0].children[0].children[i];d.children[1].children[0].value=n[c]["TIPS名"],d.children[2].children[0].value=n[c]["TIPSの要素"],d.children[3].children[0].value=n[c]["TIPS表示位置"],d.children[4].children[0].value=n[c]["TIPSの内容"],d.children[5].children[0].value=n[c]["リンク先(a要素の場合)"],k(),i++}}function S(t,n,i,r){for(var l=e("<tr>"),a=0;a<n.length;a++){var o=e("<td>");switch(n[a]){case"":o.text(I(r));break;case"input":var c=e("<input>");o.append(c.clone());break;case"select":var d=w("tipElement"===i[a]?["i","a"]:["top","right","left","bottom"]);o.append(d.clone());break;case"textarea":var p=e("<textarea>");o.append(p.clone());break;case"button":var u=e('<input type="button" value=" tips削除 " class="del-tips-config-list">');o.append(u.clone())}l.append(o.clone())}t.append(l.clone())}function b(e,t,n,i){for(var r={},l=1;l<n.length;l++){var a=n[l].children;if(""!==a[1].firstChild.value){for(var o=1===a[0].childElementCount?I(a[0].children[0].value):I(a[0].textContent),c={},d=1;d<a.length;d++)c[i[d-1]]=a[d].firstChild.value;r[o]=c}}e[t]=JSON.stringify(r)}function k(){e(".del-tips-config-list:last").on("click",(function(e){(""===(1===e.currentTarget.parentNode.parentNode.children[0].childElementCount?e.currentTarget.parentNode.parentNode.children[0].children[0].value:e.currentTarget.parentNode.parentNode.children[0].value)||window.confirm("idが入力されていますが、削除しますか？"))&&e.currentTarget.parentNode.parentNode.remove()}))}function y(e){return'"'+e+'"'}KintoneConfigHelper.getFields("SPACER").then((function(e){var t=["","input","select","select","textarea","input"],r=["tipId","tipName","tipElement","tipPosition","tipDetail","tipLink"];e.forEach((function(e){""!==e.elementId&&S(h,t,r,e.elementId)})),s.hasOwnProperty(i)&&C(s.tipsConfigDetail,h,n)})).catch((function(e){return alert("エラーが発生しました。\n"+e.message)})).then((function(){s.hasOwnProperty(r)&&E(s.tipsConfigList,g)})).then((function(){s.hasOwnProperty(d)&&C(s.cssConfig,m,c)})),p.click((function(e){S(g,l,o,""),k()})),u.click((function(){var e,t=document.getElementById("csvImportType");if("DETAIL"===(t=t[t.selectedIndex].value)?e=h:"CSS"===t?e=m:"LIST"===t&&(e=g),e[0].children[0].childElementCount<2)window.alert("設定情報がありません。エクスポート処理を中断します。");else{for(var n="",i=e[0].children[0].children,r=1;r<i.length;r++){1!==r&&(n+=',"*"\n');for(var l=i[r],a=0;a<l.childElementCount;a++){var o="input",c="",d=l.children[a];0===a&&0===d.childElementCount&&(o="text");var p="";if("text"===o?p=d.textContent:"input"===o&&(p=d.children[0].value),0===a&&""===p)break;a>0&&(c=","),n+=c+y(p)}}var u=new Date,s=t+"_"+(u.getFullYear()+("00"+(u.getMonth()+1)).slice(-2)+("00"+u.getDate()).slice(-2)+("00"+u.getHours()).slice(-2)+("00"+u.getMinutes()).slice(-2)+("00"+u.getSeconds()).slice(-2))+".csv",f=new Uint8Array([239,187,191]),v=new Blob([f,n],{type:"text/csv"}),I=(window.URL||window.webkitURL).createObjectURL(v),w=document.createElement("a");w.href=I,w.download=s,w.click(),(window.URL||window.webkitURL).revokeObjectURL(I)}})),f.on("submit",(function(e){e.preventDefault();var t=[];b(t,i,h[0].children[0].children,n),b(t,r,g[0].children[0].children,n),b(t,d,m[0].children[0].children,c),kintone.plugin.app.setConfig(t,(function(){alert("設定内容を保存しました。"),window.location.href="/k/admin/app/flow?app="+kintone.app.getId()}))})),v.click((function(){window.location.href="/k/admin/app/"+kintone.app.getId()+"/plugin/"}));var L=document.getElementById("dropArea"),T=document.getElementById("uploadFile");function x(){var e=!0,t=document.getElementById("csvImportType");return t=t[t.selectedIndex].text,window.confirm("【".concat(t,"】の設定情報をCSVファイルの内容に更新してもよろしいですか？"))||(e=!1),e}function N(e){var t=document.getElementById("inputFileInfo"),i=["File Name：","File Text：","File Size："],r=["name","type","size"];if(0!==t.childElementCount)for(var l=0;l<i.length;l++)t.firstElementChild.remove();for(var a=0;a<i.length;a++){var o=document.createElement("p");o.textContent=i[a]+e[r[a]],t.append(o)}var d=new FileReader;d.readAsText(e),d.onload=function(){!function(e){var t,i,r=document.getElementById("csvImportType");"DETAIL"===(r=r[r.selectedIndex].value)?(t=h,i=n):"CSS"===r?(t=m,i=c):"LIST"===r&&(t=g,i=n);for(var l=e.split(',"*"'),a={},o=0;o<l.length;o++){for(var d=l[o].split('",'),p={},u=1;u<d.length;u++){var s=d[u];p[i[u-1]]=s.replace(/\"/g,"")}a[d[0].replace(/\r?\n/g,"").replace(/\"/g,"")]=p}"LIST"===r?(function(e){for(var t=e[0].children[0],n=t.childElementCount-1;n>0;n--)t.children[n].remove()}(t),E(JSON.stringify(a),t)):C(JSON.stringify(a),t,i)}(d.result)}}L.addEventListener("dragover",(function(e){e.preventDefault(),L.classList.add("dragover")})),L.addEventListener("dragleave",(function(e){e.preventDefault(),L.classList.remove("dragover")})),L.addEventListener("drop",(function(e){if(e.preventDefault(),L.classList.remove("dragover"),x()){var t=e.dataTransfer.files;T.value=null,T.files=t,void 0!==t[0]&&N(t[0])}else T.value=null})),T.addEventListener("change",(function(e){if(x()){var t=e.target.files[0];void 0!==t&&(N(t),T.value=null)}else T.value=null}),!1)}(jQuery,kintone.$PLUGIN_ID);